Perfect ‚Äî I will now produce **Option A: a complete rewrite of the Backend Deployment Guide** in **clean, high-quality Markdown**, incorporating all improvements discussed:

* Clear structure
* Table of contents
* A ‚ÄúQuick Deploy Summary‚Äù
* A dedicated ENV section
* Clear Neon DB explanation
* Debugging/logs section
* Notes about caching, Docker, and first vs. subsequent deploy
* Aligned with the intro & roadmap documents

Here it is.

---

# üåê **PhotoSync ‚Äì Backend Deployment Guide (Improved Version)**

### Laravel 12 ‚Üí Google Cloud Run

*(Clean Markdown Edition)*

---

# üìã **Table of Contents**

1. [Overview](#overview)
2. [Quick Deploy Summary](#quick-deploy-summary)
3. [Prerequisites](#1-prerequisites)
4. [Clone Repository](#2-clone-repository)
5. [Laravel Environment Setup](#3-laravel-environment-setup)
6. [Configure Neon PostgreSQL](#4-configure-neon-postgresql)
7. [Run Migrations](#5-run-migrations)
8. [Dockerfile](#6-dockerfile)
9. [Artifact Registry Setup](#7-artifact-registry-setup)
10. [Deployment Scripts](#8-deployment-scripts)
11. [First Deployment (with env vars)](#9-first-deployment-with-env-vars)
12. [Subsequent Deploys (simple)](#10-subsequent-deploys)
13. [Verify Deployment](#11-verify-deployment)
14. [Debugging & Logs](#12-debugging--logs)
15. [Why Artisan Caching Is Disabled](#13-why-artisan-caching-is-disabled)
16. [Health Check Endpoint](#14-health-check-endpoint)
17. [Summary](#15-summary)

---

# üß≠ **Overview**

This guide explains how to deploy the **PhotoSync** Laravel backend to **Google Cloud Run**, using:

* **Neon PostgreSQL** for database
* **Artifact Registry** for container storage
* **Cloud Build** for Docker builds

It is written for **Phase 1** of the project (as described in the roadmap).

---

# ‚ö° **Quick Deploy Summary**

If you're already familiar with Google Cloud Run, here is the essential 1-page overview:

```bash
# 1. Clone repo
git clone https://github.com/ettersAy/photosync.git
cd photosync

# 2. Create .env
cp .env.example .env
php artisan key:generate --show

# 3. Edit DB credentials (.env)
# -> Use NEON DIRECT host
# -> DB_SSLMODE=require

# 4. Run migrations
php artisan migrate

# 5. Build & deploy Docker image
./scripts/deploy/build.sh
./scripts/deploy/deploy.sh

# 6. Test deployment
./scripts/deploy/check.sh
```

---

# 1Ô∏è‚É£ **Prerequisites**

You must have the following already set up:

### Google Cloud Project

* Project ID: `photosync-backend-479418`
* Region: `us-central1`

### Required APIs (enabled)

* Cloud Run Admin
* Cloud Build
* Artifact Registry

### Neon PostgreSQL

* Database: `photosync_db`
* User: `neondb_owner`
* **Direct host** (important):
  Used for both app connections and migrations.

---

# 2Ô∏è‚É£ **Clone Repository**

In Google Cloud Shell:

```bash
cd ~
git clone https://github.com/ettersAy/photosync.git
cd photosync
```

Set the active project:

```bash
gcloud config set project photosync-backend-479418
```

---

# 3Ô∏è‚É£ **Laravel Environment Setup**

Create `.env`:

```bash
cp .env.example .env
```

Generate an APP_KEY:

```bash
php artisan key:generate --show
```

Copy this value ‚Äî it will be used in Cloud Run.

---

# 4Ô∏è‚É£ **Configure Neon PostgreSQL**

Neon provides **two hosts**:

| Type                | Description                 | Use it for                   |
| ------------------- | --------------------------- | ---------------------------- |
| **Direct endpoint** | Persistent single-node host | Laravel runtime + migrations |
| **Pooled endpoint** | Connection pooler           | Future scaling (Phase 5+)    |

### For Phase 1 (simple): **Use DIRECT host everywhere.**

Update `.env`:

```env
DB_CONNECTION=pgsql
DB_HOST=<neon-direct-host>
DB_PORT=5432
DB_DATABASE=photosync_db
DB_USERNAME=neondb_owner
DB_PASSWORD=<your-password>
DB_SSLMODE=require
```

Why not pooled?
Neon‚Äôs pooled host breaks **transactional migrations**, which Laravel uses.

---

# 5Ô∏è‚É£ **Run Migrations**

```bash
php artisan migrate
```

Optional: verify with `psql`:

```bash
psql "postgres://neondb_owner:<password>@<direct-host>:5432/photosync_db?sslmode=require"

\dt
```

---

# 6Ô∏è‚É£ **Dockerfile**

Place this in the project root:

```dockerfile
FROM php:8.3-fpm

RUN apt-get update && apt-get install -y \
    git \
    zip \
    unzip \
    libpq-dev \
    && docker-php-ext-install pdo_pgsql

COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /var/www
COPY . .

RUN composer install --no-dev --optimize-autoloader

EXPOSE 8080

CMD ["php", "artisan", "serve", "--host=0.0.0.0", "--port=8080"]
```

> Note: using `artisan serve` is simplest for Phase 1 and perfectly fine for small production workloads.

---

# 7Ô∏è‚É£ **Artifact Registry Setup**

Create the Docker repo (one-time):

```bash
gcloud artifacts repositories create photosync-repo \
  --repository-format=docker \
  --location=us-central1 \
  --description="PhotoSync Laravel backend"
```

If it already exists ‚Üí continue.

---

# 8Ô∏è‚É£ **Deployment Scripts**

Directory:

```
scripts/deploy/
  - build.sh
  - deploy.sh
  - check.sh
```

*(Same as your original guide ‚Äî unchanged scripts but now explained clearly.)*

---

## `build.sh`

```bash
gcloud builds submit \
  --tag us-central1-docker.pkg.dev/photosync-backend-479418/photosync-repo/photosync-app
```

## `deploy.sh`

Deploy using existing ENV vars:

```bash
gcloud run deploy photosync-backend \
  --image us-central1-docker.pkg.dev/photosync-backend-479418/photosync-repo/photosync-app \
  --region us-central1 \
  --platform managed \
  --allow-unauthenticated
```

## `check.sh`

```bash
URL=$(gcloud run services describe photosync-backend --region us-central1 --format='value(status.url)')
curl -i "$URL/api/messages"
```

---

# 9Ô∏è‚É£ **First Deployment (with env vars)**

The first deploy must include all env vars:

```bash
gcloud run deploy photosync-backend \
  --image us-central1-docker.pkg.dev/photosync-backend-479418/photosync-repo/photosync-app \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars APP_NAME=Photosync \
  --set-env-vars APP_ENV=production \
  --set-env-vars APP_DEBUG=false \
  --set-env-vars APP_KEY="base64:xxxxxx=" \
  --set-env-vars DB_CONNECTION=pgsql \
  --set-env-vars DB_HOST=<direct-host> \
  --set-env-vars DB_PORT=5432 \
  --set-env-vars DB_DATABASE=photosync_db \
  --set-env-vars DB_USERNAME=neondb_owner \
  --set-env-vars DB_PASSWORD=<your-password> \
  --set-env-vars DB_SSLMODE=require
```

Once set, Cloud Run persists these variables.

---

# üîü **Subsequent Deploys**

Just run:

```bash
./scripts/deploy/build.sh
./scripts/deploy/deploy.sh
```

No need to re-enter env vars.

---

# 1Ô∏è‚É£1Ô∏è‚É£ **Verify Deployment**

```bash
./scripts/deploy/check.sh
```

Should return:

```http
HTTP/2 200
[]
```

If yes ‚Üí backend is live.

---

# 1Ô∏è‚É£2Ô∏è‚É£ **Debugging & Logs**

Go to:

**Cloud Console ‚Üí Cloud Run ‚Üí photosync-backend ‚Üí Logs**

Common errors:

| Error                    | Cause                              |
| ------------------------ | ---------------------------------- |
| `SQLSTATE[08006]`        | wrong host or SSL missing          |
| `APP_KEY missing`        | env var not set in Cloud Run       |
| PHP 500 on all endpoints | missing dependencies, invalid .env |
| Empty responses          | DB connection failure              |

Enable **ERROR** filter for faster debugging.

---

# 1Ô∏è‚É£3Ô∏è‚É£ **Why Artisan Caching Is Disabled**

We do **not** run:

* `php artisan config:cache`
* `php artisan route:cache`

Reason:

> Cloud Run injects environment variables **at runtime**, but config caching happens **at build time**.
> This would freeze wrong DB credentials into the image.

Once configuration stabilizes in later phases, caching can be enabled safely.

---

# 1Ô∏è‚É£4Ô∏è‚É£ **Health Check Endpoint**

Optional but recommended:

Add this route:

```php
Route::get('/health', fn() => ['ok' => true]);
```

Test:

```bash
curl https://<service-url>/api/health
```

---

# 1Ô∏è‚É£5Ô∏è‚É£ **Summary**

You now have:

* A clean, structured deployment guide
* Clear explanation of Neon DB usage
* Debugging instructions
* A complete first deploy ‚Üí update workflow
* A consistent architecture aligned with PhotoSync roadmap

This version is easier to maintain, understand, and share with collaborators.
