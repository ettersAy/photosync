# ðŸ”§ **US-009 : Deploy Laravel Backend to Google Cloud Run**

**Role:** Cloud DevOps engineer for the `photosync` Laravel backend.

**Goal:** Containerize the Laravel app, push the image to Artifact Registry, and deploy it to Cloud Run using the existing Google Cloud project:
**`photosync-backend-479418`**

---

## ðŸ“Œ **Instructions for the AI Agent**

### **1. Create Dockerfile in project root**

Create `Dockerfile` with:

```dockerfile
FROM php:8.3-fpm

RUN apt-get update && apt-get install -y git zip unzip libpq-dev \
    && docker-php-ext-install pdo_pgsql

COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /var/www

COPY . .

RUN composer install --no-dev --optimize-autoloader
RUN php artisan config:cache || true
RUN php artisan route:cache || true

EXPOSE 8080
CMD ["php", "artisan", "serve", "--host=0.0.0.0", "--port=8080"]
```

---

### **2. Create an Artifact Registry repository**

Using `gcloud` in Cloud Shell:

```bash
gcloud artifacts repositories create photosync-repo \
  --repository-format=docker \
  --location=us-central1 \
  --description="Photosync Laravel backend images" \
  --project=YOUR_PROJECT_ID

```

---

### **3. Build & push container image**

```bash
gcloud builds submit --tag us-central1-docker.pkg.dev/photosync-backend-479418/photosync-repo/photosync-app
```

---

### **4. Deploy to Cloud Run**

```bash
gcloud run deploy photosync-backend \
  --image us-central1-docker.pkg.dev/photosync-backend-479418/photosync-repo/photosync-app \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars DB_CONNECTION=pgsql \
  --set-env-vars DB_HOST=ep-lucky-glade-adsw37r5.c-2.us-east-1.aws.neon.tech \
  --set-env-vars DB_PORT=5432 \
  --set-env-vars DB_DATABASE=photosync_db \
  --set-env-vars DB_USERNAME=neondb_owner \
  --set-env-vars DB_PASSWORD=npg_jp2D5iPKcQNR \
  --set-env-vars DB_SSLMODE=require

```

Replace `<direct-neon-host>` with your direct Neon endpoint.

---

### **5. Output Required**

After deployment, the agent should return:

1. The **Cloud Run HTTPS URL** (example: `https://photosync-backend-xxxxx.a.run.app`)
2. Confirmation that `/api/messages` endpoint responds

   * `GET /api/messages` â†’ `200 OK`
   * `POST /api/messages` â†’ `201 Created`

This URL will be used for the Vercel frontend next.
