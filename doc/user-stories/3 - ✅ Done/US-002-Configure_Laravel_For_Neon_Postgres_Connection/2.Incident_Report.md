# **Incident Report – Laravel Migration Failure on Neon**

## **1. Error Description**

* **Error:** `SQLSTATE[25P02]: In failed sql transaction: current transaction is aborted, commands ignored until end of transaction block`
* **Trigger:** Running migrations with `php artisan migrate --force`
* **Also triggered by:** `php artisan migrate --path=database/migrations/xxxx.php`

---

## **2. Debugging Actions (Short Summary)**

* Verified DB connection using `psql`
* Checked for stuck transactions (`pg_stat_activity`)
* Confirmed only `migrations` table existed (`\dt`)
* Tried isolated migration files → failed
* Created new migration files → failed
* Deleted old migrations → failed
* Ran `php artisan db:wipe --force` → still failed
* Disabled transactions in migrations → still failed
* Tried raw SQL migrations → still failed
* Identified suspicious use of **Neon pooled endpoint**

---

## **3. Final Fix (Detailed but Brief)**

### **Root Cause**

Laravel wraps migrations in a transaction.
Neon's **pooled endpoint** (`...-pooler...`) does **not** support transactional DDL → triggers `25P02` errors.

### **Solution**

**Step 1 — Add the direct Neon endpoint to `.env`**

```env
DB_HOST=ep-xxxx-pooler.c-2.us-east-1.aws.neon.tech        # pooled (for app)
DB_HOST_DIRECT=ep-xxxx.us-east-1.aws.neon.tech            # direct (for migrations)
DB_DATABASE=photosync_db
DB_USERNAME=neondb_owner
DB_PASSWORD=xxxx
```

**Step 2 — Add a second connection in `config/database.php`**

```php
'pgsql_direct' => [
    'driver' => 'pgsql',
    'host' => env('DB_HOST_DIRECT'),
    'database' => env('DB_DATABASE'),
    'username' => env('DB_USERNAME'),
    'password' => env('DB_PASSWORD'),
    'charset' => 'utf8',
    'schema' => 'public',
    'sslmode' => 'require',
],
```

**Step 3 — Run migrations using the direct endpoint**

```bash
php artisan migrate --force --database=pgsql_direct
```

✔️ All migrations succeeded.
✔️ No more transaction aborts.

---

## **4. What We Learned**

* Neon’s **pooled** endpoint breaks Laravel’s transactional migrations.
* Always run migrations on the **direct** endpoint.
* App runtime can safely use pooled connections, but schema changes cannot.
