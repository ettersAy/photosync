## US-011 – Backend: Separate local (dev) DB from prod DB


**Goal:**

* Local `php artisan serve` uses a **dev Neon DB**
* Cloud Run keeps using the **existing prod Neon DB**
* Your local app works again with `php artisan serve`

We’ll treat your **current Neon DB (`photosync_db`) as PROD**, and create a new **DEV DB**.

---

### 1️⃣ Create a dev DB in Neon

In Neon UI:

1. Go to your **photosync** project.
2. Either:

   * Create a **new database** called e.g. `photosync_dev_db`,
     **or**
   * Create a **new branch** (like `dev`) and a DB inside it.

You should end up with a **separate connection string** for dev, something like:

```text
postgres://neondb_owner:<dev-password>@<dev-direct-host>:5432/photosync_dev_db
```

Make sure you use the **direct host** (not the `-pooler` one).

---

### 2️⃣ Update your local `.env` for DEV

In Cloud Shell, from the Laravel root:

```bash
cd ~/photosync
nano .env
```

Set these values to your **dev DB**:

```env
APP_ENV=local
APP_DEBUG=true

DB_CONNECTION=pgsql
DB_HOST=<dev-direct-host>          # e.g. ep-xxx.us-east-1.aws.neon.tech
DB_PORT=5432
DB_DATABASE=photosync_dev_db
DB_USERNAME=neondb_owner
DB_PASSWORD=<dev-password>
DB_SSLMODE=require
```

> Important: this `.env` is for **local only**.
> Cloud Run uses env vars defined in its service, so you **don’t** break prod by changing `.env`.

Save and exit: `CTRL+O`, Enter, `CTRL+X`.

---

### 3️⃣ Run migrations against the DEV DB

```bash
php artisan optimize:clear
php artisan migrate --force --database=pgsql_direct
```

You should see all migrations run and new tables created **only in `photosync_dev_db`**.

(Optional) Check using `psql` (dev connection):

```bash
psql "postgres://neondb_owner:<dev-password>@<dev-direct-host>:5432/photosync_dev_db?sslmode=require"

\dt
\d messages
```

You should see `messages` and other Laravel tables.

---

### 4️⃣ Test local backend

Now run:

```bash
php artisan serve --host=0.0.0.0 --port=8000
```

* Hit `http://localhost:8000` or your preview URL.
* The app should load again locally.
* When the frontend calls `/api/messages` (through `VITE_API_URL=http://localhost:8000`), it should now write to the **dev DB**.

---

### ✅ What we’ve achieved with Task 1

* **Prod DB** (old `photosync_db`) is only used by **Cloud Run** via its env vars.
* **Dev DB** (`photosync_dev_db`) is used only by **local `.env` + php artisan serve**.
* You can test locally without touching production data.
